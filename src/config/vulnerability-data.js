const path = require('path');

const vulnerabilityDataConfig = {
  enabled: true,
  
  dataSources: {
    nvd: {
      enabled: true,
      apiKey: process.env.NVD_API_KEY || null,
      syncInterval: '24h',
      priority: 1,
      description: 'National Vulnerability Database (NVD) - Official US government vulnerability database'
    },
    
    github: {
      enabled: true,
      token: process.env.GITHUB_TOKEN || null,
      syncInterval: '3h',
      priority: 2,
      description: 'GitHub Advisory Database - Community-driven vulnerability database'
    },
    
    vue: {
      enabled: true,
      token: process.env.GITHUB_TOKEN || null,
      syncInterval: '6h',
      priority: 3,
      description: 'Vue Ecosystem Security - Vue.js specific vulnerabilities'
    }
  },
  
  storage: {
    enabled: true,
    path: path.join(process.cwd(), 'data', 'vulnerability-db.json'),
    format: 'json',
    compression: false
  },
  
  cache: {
    enabled: true,
    ttl: '1h',
    maxSize: 100,
    strategy: 'lru'
  },
  
  sync: {
    autoSync: false,
    syncOnStartup: false,
    syncInterval: '24h',
    maxRetries: 3,
    retryDelay: 5000
  },
  
  analysis: {
    enableDependencyAnalysis: true,
    enableVersionMatching: true,
    enableSeverityAssessment: true,
    enableContextAwareAnalysis: true,
    maxVulnerabilitiesPerDependency: 10
  },
  
  reporting: {
    includeSource: true,
    includeCVSS: true,
    includeReferences: true,
    includeAffectedVersions: true,
    format: 'detailed'
  },
  
  performance: {
    maxConcurrentRequests: 5,
    requestTimeout: 30000,
    enableRateLimiting: true,
    enableCaching: true
  }
};

function getConfig() {
  return vulnerabilityDataConfig;
}

function getDataSourceConfig(sourceName) {
  return vulnerabilityDataConfig.dataSources[sourceName] || null;
}

function isDataSourceEnabled(sourceName) {
  const config = getDataSourceConfig(sourceName);
  return config ? config.enabled : false;
}

function getStoragePath() {
  return vulnerabilityDataConfig.storage.path;
}

function getCacheConfig() {
  return vulnerabilityDataConfig.cache;
}

function getSyncConfig() {
  return vulnerabilityDataConfig.sync;
}

function getAnalysisConfig() {
  return vulnerabilityDataConfig.analysis;
}

function getReportingConfig() {
  return vulnerabilityDataConfig.reporting;
}

function getPerformanceConfig() {
  return vulnerabilityDataConfig.performance;
}

function updateConfig(updates) {
  Object.assign(vulnerabilityDataConfig, updates);
}

function validateConfig() {
  const errors = [];
  
  if (!vulnerabilityDataConfig.enabled) {
    return errors;
  }
  
  if (vulnerabilityDataConfig.storage.enabled) {
    const storageDir = path.dirname(vulnerabilityDataConfig.storage.path);
    try {
      const fs = require('fs-extra');
      if (!fs.existsSync(storageDir)) {
        fs.ensureDirSync(storageDir);
      }
    } catch (error) {
      errors.push(`Storage directory error: ${error.message}`);
    }
  }
  
  const enabledSources = Object.entries(vulnerabilityDataConfig.dataSources)
    .filter(([name, config]) => config.enabled)
    .map(([name]) => name);
    
  if (enabledSources.length === 0) {
    errors.push('No data sources are enabled');
  }
  
  return errors;
}

function printConfig() {
  console.log('Vulnerability Data Configuration:');
  console.log('================================');
  console.log(`Enabled: ${vulnerabilityDataConfig.enabled}`);
  console.log('\nData Sources:');
  Object.entries(vulnerabilityDataConfig.dataSources).forEach(([name, config]) => {
    console.log(`  ${name}:`);
    console.log(`    Enabled: ${config.enabled}`);
    console.log(`    Priority: ${config.priority}`);
    console.log(`    Sync Interval: ${config.syncInterval}`);
    console.log(`    Description: ${config.description}`);
  });
  console.log('\nStorage:');
  console.log(`  Enabled: ${vulnerabilityDataConfig.storage.enabled}`);
  console.log(`  Path: ${vulnerabilityDataConfig.storage.path}`);
  console.log(`  Format: ${vulnerabilityDataConfig.storage.format}`);
  console.log('\nCache:');
  console.log(`  Enabled: ${vulnerabilityDataConfig.cache.enabled}`);
  console.log(`  TTL: ${vulnerabilityDataConfig.cache.ttl}`);
  console.log(`  Max Size: ${vulnerabilityDataConfig.cache.maxSize}`);
  console.log('\nSync:');
  console.log(`  Auto Sync: ${vulnerabilityDataConfig.sync.autoSync}`);
  console.log(`  Sync on Startup: ${vulnerabilityDataConfig.sync.syncOnStartup}`);
  console.log(`  Sync Interval: ${vulnerabilityDataConfig.sync.syncInterval}`);
  console.log('================================');
}

module.exports = {
  getConfig,
  getDataSourceConfig,
  isDataSourceEnabled,
  getStoragePath,
  getCacheConfig,
  getSyncConfig,
  getAnalysisConfig,
  getReportingConfig,
  getPerformanceConfig,
  updateConfig,
  validateConfig,
  printConfig
};
