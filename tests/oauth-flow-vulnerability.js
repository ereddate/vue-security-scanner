// OAuth Flow Vulnerability 漏洞示例文件

// 示例 1: 缺少状态参数
export function oauthFlowVulnerabilityExample1() {
  const express = require('express');
  const app = express();
  
  app.get('/auth', (req, res) => {
    const clientId = 'client123';
    const redirectUri = 'http://localhost:3000/callback';
    
    // 危险：缺少 state 参数
    const authUrl = `https://oauth-provider.com/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code`;
    res.redirect(authUrl);
  });
  
  return app;
}

// 示例 2: 不验证 state 参数
export function oauthFlowVulnerabilityExample2() {
  const express = require('express');
  const app = express();
  
  app.get('/callback', (req, res) => {
    const { code, state } = req.query;
    
    // 危险：不验证 state 参数
    exchangeCodeForToken(code);
    
    res.send('Authenticated');
  });
  
  return app;
}

// 示例 3: 泄露 client secret
export function oauthFlowVulnerabilityExample3() {
  const express = require('express');
  const app = express();
  
  app.get('/callback', (req, res) => {
    const { code } = req.query;
    const clientId = 'client123';
    const clientSecret = 'secret-12345';
    
    // 危险：在前端代码中暴露 client secret
    res.json({
      clientId: clientId,
      clientSecret: clientSecret
    });
  });
  
  return app;
}

// 示例 4: 不验证 redirect URI
export function oauthFlowVulnerabilityExample4() {
  const express = require('express');
  const app = express();
  
  app.get('/callback', (req, res) => {
    const { code, redirect_uri } = req.query;
    
    // 危险：不验证 redirect URI
    exchangeCodeForToken(code, redirect_uri);
    
    res.send('Authenticated');
  });
  
  return app;
}

// 示例 5: 授权码注入
export function oauthFlowVulnerabilityExample5() {
  const express = require('express');
  const app = express();
  
  app.get('/callback', (req, res) => {
    const { code } = req.query;
    
    // 危险：不验证授权码
    const token = exchangeCodeForToken(code);
    
    res.json({ token });
  });
  
  return app;
}

// 示例 6: Token 泄露
export function oauthFlowVulnerabilityExample6() {
  const express = require('express');
  const app = express();
  
  app.get('/token', (req, res) => {
    const token = req.headers.authorization;
    
    // 危险：在日志中记录 token
    console.log('Token:', token);
    
    res.send('OK');
  });
  
  return app;
}

// 示例 7: 缺少 PKCE
export function oauthFlowVulnerabilityExample7() {
  const express = require('express');
  const app = express();
  
  app.get('/auth', (req, res) => {
    const clientId = 'client123';
    const redirectUri = 'http://localhost:3000/callback';
    
    // 危险：缺少 PKCE
    const authUrl = `https://oauth-provider.com/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code`;
    res.redirect(authUrl);
  });
  
  return app;
}

// 示例 8: 不验证 scope
export function oauthFlowVulnerabilityExample8() {
  const express = require('express');
  const app = express();
  
  app.get('/callback', (req, res) => {
    const { code, scope } = req.query;
    
    // 危险：不验证 scope
    const token = exchangeCodeForToken(code);
    
    res.json({ token, scope });
  });
  
  return app;
}

// 示例 9: CSRF 攻击
export function oauthFlowVulnerabilityExample9() {
  const express = require('express');
  const app = express();
  
  app.get('/auth', (req, res) => {
    const clientId = 'client123';
    const redirectUri = 'http://localhost:3000/callback';
    
    // 危险：容易受到 CSRF 攻击
    const authUrl = `https://oauth-provider.com/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code`;
    res.redirect(authUrl);
  });
  
  return app;
}

// 示例 10: 不安全的 token 存储
export function oauthFlowVulnerabilityExample10() {
  const express = require('express');
  const app = express();
  
  app.post('/login', (req, res) => {
    const { token } = req.body;
    
    // 危险：不安全地存储 token
    res.cookie('access_token', token, {
      httpOnly: false,
      secure: false
    });
    
    res.json({ success: true });
  });
  
  return app;
}
